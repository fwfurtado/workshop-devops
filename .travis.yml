language: java

services:
  - docker

stages:
  - build
  - deploy

jobs:
  include:
    - stage: build
      name: 'Building docker image without tests'
      script:
        - make build/docker
    - stage: deploy
      if: tag IS present
      name: 'Deploy application on heroku'
      before_script:
        - docker login --username=_ --password=$HEROKU_AUTH_TOKEN registry.heroku.com
      script:
        - make tag/docker tag=registry.heroku.com/workshop-devops/web
      after_script:
        - docker push registry.heroku.com/workshop-devops/web